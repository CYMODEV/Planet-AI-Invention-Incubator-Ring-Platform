// services/tokens/src/server.ts
import express from "express";
import { Pool } from "pg";
import { v4 as uuid } from "uuid";

const db = new Pool({ connectionString: process.env.POSTGRES_URL });
const app = express();
app.use(express.json());

app.post("/mint/:inventionId", async (req, res) => {
  const inventionId = req.params.inventionId;
  const { utility = 2, identity = 1, heritage = 1 } = req.body;
  const id = uuid();
  const mintedAt = new Date().toISOString();
  const txId = "TX-" + uuid();

  await db.query(
    "INSERT INTO token_mints(id,invention_id,classes,tx_id,minted_at) VALUES($1,$2,$3,$4,$5)",
    [id, inventionId, { utility, identity, heritage }, txId, mintedAt]
  );
  await db.query("UPDATE inventions SET status='tokenized' WHERE id=$1", [inventionId]);
  res.json({ id, inventionId, classes: { utility, identity, heritage }, txId, mintedAt });
});

app.listen(3005, () => console.log("Tokens on :3005"));
